@model Werewolf.Models.ViewModel.PlayViewModel;
@{
    ViewData["Title"] = "Play";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-md-3">
        <partial name="_CharacterCardPartial" model="@Model.Character" />
    </div>
    <div class="col-md-9">
        <div class="row">
            <!--  VOTE SECTION  -->
            <div class="container d-flex">
                <div class="h4 text-info mb-0 align-self-center">
                    The @Model.Character.Game.TurnType
                </div>

                @if (Model.Character.Game.TurnType == SD.Night)
                {
                    //NIGHT
                    if (Model.Character.Role == SD.Werewolf)
                    {
                        //WEREWOLF
                        <div class="ml-auto h4 text-secondary align-self-center mb-0 text-right">
                            Werewolve, pick someone to kill.
                        </div>
                        <div class="ml-auto">
                            <select data-gameid="@Model.Character.GameId" data-role="@Model.Character.Role" data-currentvoteuserid="@(Model.Vote == null ? string.Empty : Model.Vote.UserVotedId)" id="@(Model.Vote == null ? 0 : Model.Vote.Id)" asp-items="Model.VoteList.ToSelectListItems(Model.Vote == null ? string.Empty : Model.Vote.UserVotedId)" class="form-control form-control-lg">
                                <option selected value="  "> -- select an option -- </option>
                            </select>
                        </div>
                    }
                    else if (Model.Character.Role == SD.Doctor)
                    {
                        //DOCTOR
                        <div class="ml-auto h4 text-secondary align-self-center mb-0 text-right">
                            Doctor, who would you like to heal?
                        </div>
                        <div class="ml-auto">
                            <select data-gameid="@Model.Character.GameId" data-role="@Model.Character.Role" data-currentvoteuserid="@(Model.Vote == null ? string.Empty : Model.Vote.UserVotedId)" id="@(Model.Vote == null ? 0 : Model.Vote.Id)" asp-items="Model.VoteList.ToSelectListItems(Model.Vote == null ? string.Empty : Model.Vote.UserVotedId)" class="form-control form-control-lg">
                                <option selected value="  "> -- select an option -- </option>
                            </select>
                        </div>

                    }
                    else if (Model.Character.Role == SD.Seer)
                    {
                        //SEER

                    }
                }
                else
                {
                    //DAY
                }
            </div>
        </div>

        <div class="row">
            <!--  OPPONENT SECTION  -->
            @foreach (var oppenent in Model.Opponents)
            {
                OpponentCardViewModel OpponentCardVm = new OpponentCardViewModel()
                {
                    Opponent = oppenent,
                    CharacterRole = Model.Character.Role,
                    Note = Model.Notes.FirstOrDefault(c => c.OpponentId == oppenent.ApplicationUserId),
                    VoteCasted = Model.VoteCasted
                };

                //var note = Model.Notes.FirstOrDefault(c => c.OpponentId == oppenent.ApplicationUserId);

                //OpponentCardVm.Note = note == null ? "" : note.Message;

                <div class="col-md-6 col-lg-4">
                    <partial name="_OpponentsCardPartial" model="@OpponentCardVm" />
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/note.js" asp-append-version="true"></script>

    <script>
        $('select').on('change', getValueFromTheVote);

        function getValueFromTheVote(e) {
            let id, gameId, role, userVoteId, currentUserVoteId;
            id = e.target.id;
            gameId = $(e.target).data('gameid');
            role = $(e.target).data('role');
            currentUserVoteId = $(e.target).data('currentvoteuserid');
            userVoteId = $(e.target).val();

            $(e.target).blur();

            if (id == 0) {
                //Add New Vote
                AddVote(e.target, gameId, role, userVoteId);
            } else {
                //Update Vote
                UpdateVote(e.target, id, userVoteId);
            }
        };

        function AddVote(el, gameId, role, userVoteId) {
            var data = { gameId: gameId, role: role, userVoteId: userVoteId };

            $.ajax({
                url: `/Game/Play/AddVote`,
                type: "post",
                contentType: 'application/x-www-form-urlencoded',
                data: data,
                success: function (result) {

                    if (result.success) {
                        toastr.success(result.message);

                        //Add new Id to the element DOM
                        el.id = result.id;

                        //Add currentUserVoteId to the element Data
                        $(el).attr('data-currentvoteuserid', userVoteId);

                        //Add Vote to the DOM
                        AddVoteToDOM(userVoteId);
                    } else {
                        toastr.error(result.message);
                    }
                }
            });
        };

        function UpdateVote(el, id, userVoteId) {
            var data = { id: id, userVoteId: userVoteId };

            $.ajax({
                url: `/Game/Play/UpdateVote`,
                type: "post",
                contentType: 'application/x-www-form-urlencoded',
                data: data,
                success: function (data) {

                    if (data.success) {
                        toastr.success(data.message);

                        //Remove the previous vote
                        RemoveVoteFromDOM($(el).attr('data-currentvoteuserid'));

                        //change the DOM with the new Id
                        $(el).attr('data-currentvoteuserid', userVoteId);

                        //Add Vote to the DOM
                        AddVoteToDOM(userVoteId);

                    } else {
                        toastr.error(data.message);
                    }
                }
            });
        };

        function AddVoteToDOM(vote) {
            var current = $('#voteReceived-' + vote).text();
            $('#voteReceived-' + vote).text(parseInt(current) + 1);
        };

        function RemoveVoteFromDOM(vote) {
            var current = $('#voteReceived-' + vote).text();
            $('#voteReceived-' + vote).text(parseInt(current) - 1);
        };
    </script>
}